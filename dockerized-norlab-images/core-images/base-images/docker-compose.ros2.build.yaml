services:

  global-service-builder-config:
#    extends: # ToDo: on dev task end >> mute next bloc ↓↓
#      file: ../docker-compose.global.yaml
#      service: global-service-dev-config
    build:
      context: ../global
      dockerfile: ../global/Dockerfile.global
      additional_contexts:
        context-dn-container-tools: ../../container-tools/
        context-dn-submodules: ../../../utilities/
        context-dn-root: ../../../
      args:
        IS_TEAMCITY_RUN: ${IS_TEAMCITY_RUN}
        TARGET_DEVICE: jetson
      platforms:
        - linux/arm64
      labels:
        org.opencontainers.image.authors: "luc.coupal.1@ulaval.ca"
    pull_policy: missing # Note: enforce pulling image only if not available in cache

  # ....ROS2 base images...........................................................................
  base-image-ros2-clean-main:
    extends: global-service-builder-config
    build:
      context: .
      dockerfile: Dockerfile.ros2
      target: ros2-install
      args:
        BASE_IMAGE: ${DN_HUB:?err}/dockerized-norlab-base-image-squashed
#        BASE_IMAGE_TAG: ${DN_IMAGE_TAG:?err}
        # (CRITICAL) ToDo: validate 'DN_IMAGE_TAG_NO_ROS'
        BASE_IMAGE_TAG: ${DN_IMAGE_TAG_NO_ROS:?err}
        ROS_DISTRO: ${ROS_DISTRO}
        ROS_PKG: ${ROS_PKG}

  base-image-ros2-clean-tester:
    extends: base-image-ros2-clean-main
    build:
      target: test
    depends_on:
      - base-image-ros2-clean-main

  base-image-ros2-clean:
    extends: base-image-ros2-clean-main
    image: ${DN_HUB:?err}/dockerized-norlab-base-image-ros2-clean:${DN_IMAGE_TAG:?err}
    build:
      target: final
    depends_on:
      - base-image-ros2-clean-main
